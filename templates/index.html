<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carbon Control</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>

<body class="hidden-content">

    <!-- Contenedor para el video de carga -->
    <div id="video-overlay">
        <video autoplay muted playsinline id="loading-video">
            <source src="/static/videos/Intro.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    </div>

    <!-- Contenido de la página -->
    <div id="container">
        <aside id="sidebar" class="sidebar-collapsed"> <!-- Agrega class="sidebar-collapsed" aquí -->
            <div id="search-container">
                <input type="text" placeholder="Search" id="search-bar">
                <i class="fas fa-search search-icon" style="color: #c4c7c5;"></i>
            </div>
            <div id="menu">
                <button>Local Data</button>
                <button>Map Layers</button>
                <button>Leaderboard</button>
                <button>Help</button>
                <button onclick="showIntroductionBox()">Introduction</button>
                <button onclick="showAboutBox()">About the Creator</button>
            </div>
            <div id="info">Monitor your eco-actions, earn rewards, and help the planet.</div>
        </aside>

        <main class="main-expanded"> <!-- Agrega class="main-expanded" aquí -->
            <div id="top-menu">
                <button id="sidebar-toggle" class="toggle-btn">
                    <i class="fas fa-bars"></i>
                </button>
                <img src="{{ url_for('static', filename='images/Pford_2.jpg') }}" alt="Carbon Control Logo"
                    class="logo">

                <!-- Pop-up con créditos del usuario (correo y puntos) -->
                <div id="user-credit-popup" class="pford-popup hidden">
                    <div class="popup-header">
                        <img src="/static/images/Pford_2.jpg" alt="Pford Icon" class="pford-icon">
                        <span class="popup-title">Tus Créditos</span>
                    </div>
                    <div class="popup-divider"></div>
                    <p id="popup-user-email" class="popup-text"></p>
                    <p id="popup-user-credits" class="popup-text"></p>
                </div>

                <!-- Agrega este popup justo después del popup de user-credit-popup: -->
                <div id="redeem-popup" class="pford-popup hidden">
                    <div class="popup-header">
                        <img src="/static/images/Pford_2.jpg" alt="Pford Icon" class="pford-icon">
                        <span class="popup-title">Canjear Acciones Ecológicas</span>
                        <button class="close-button" onclick="closeRedeemPopup()">&times;</button>
                    </div>
                    <div class="popup-divider"></div>
                    <p class="popup-text">
                        Sube evidencia de tu acción ecológica para canjear tus créditos.
                        Asegúrate que la imagen sea clara y muestre tu contribución ambiental.
                    </p>
                    <div class="input-container">
                        <label for="action-description">Descripción breve:</label>
                        <input type="text" id="action-description" placeholder="Ej: Planté 5 árboles en el parque">
                    </div>
                    <div class="input-container">
                        <label for="action-image">Subir imagen:</label>
                        <input type="file" id="action-image" accept="image/*">
                    </div>
                    <div class="popup-divider"></div>
                    <button class="accept-button" onclick="submitRedeemAction()">Enviar Evidencia</button>
                    <div id="redeem-success" style="display: none; text-align: center; margin-top: 15px;">
                        <i class="fas fa-check-circle" style="color: #4CAF50; font-size: 50px;"></i>
                        <p style="color: white; margin-top: 10px;">¡Evidencia enviada con éxito!</p>
                    </div>
                </div>

                <!-- Popup para Report Actions -->
                <div id="report-popup" class="pford-popup hidden">
                    <div class="popup-header">
                        <img src="/static/images/Pford_2.jpg" alt="Pford Icon" class="pford-icon">
                        <span class="popup-title">Reportar Acción Ecológica</span>
                        <button class="close-button" onclick="closeReportPopup()">&times;</button>
                    </div>
                    <div class="popup-divider"></div>
                    <p class="popup-text">
                        Reporta una acción ecológica que hayas realizado para validación.
                        Debes estar logeado para reportar acciones.
                    </p>
                    <div id="report-login-message"
                        style="text-align: center; color: #ff4757; margin: 15px 0; display: none;">
                        Debes iniciar sesión para reportar acciones
                    </div>
                    <div id="report-form" style="display: none;">
                        <div class="input-container">
                            <label for="report-description">Descripción:</label>
                            <input type="text" id="report-description" placeholder="Ej: Recogí 5 kg de basura">
                        </div>
                        <div class="input-container">
                            <label for="report-image">Evidencia (imagen):</label>
                            <input type="file" id="report-image" accept="image/*">
                        </div>
                        <div class="popup-divider"></div>
                        <button class="accept-button" onclick="submitReportAction()">Enviar Reporte</button>
                    </div>
                </div>

                <button>Home</button>
                <button id="report-actions-btn">Report Actions</button>
                <button id="redeem-actions-btn">Redeem Actions</button>
                <button id="toggle-live-data">Global CO₂ Evolution</button>

                <!-- Pford Credits Button with Clickable Pop-up -->
                <div id="pford-credits-container">
                    <button id="pford-credits-button">Sign up</button>
                    <!-- Pop-up Box (Initially Hidden) -->
                    <div id="pford-credits-box" class="pford-popup">
                        <div class="popup-header">
                            <img src="/static/images/Pford_2.jpg" alt="Pford Icon" class="pford-icon">
                            <span class="popup-title">Pford Credits</span>
                        </div>
                        <div class="popup-divider"></div>
                        <p class="popup-text">
                            Pford Credits are rewards you can earn by taking eco-friendly actions. These credits can be
                            redeemed
                            for benefits such as free public transport, discounts, and environmental incentives.
                            Join the movement and start earning today!
                        </p>
                        <div class="popup-divider"></div>
                        <button class="signup-button">Sign Up</button>

                        <!-- New Login Section -->
                        <p class="login-text-small">Already have an account?</p>
                        <p class="login-link"><a href="#" onclick="showLogin()">Log in</a></p>
                    </div>
                </div>
                <div id="user-menu" style="display: none;">
                    <span id="user-email-display" style="color: white; margin-right: 15px;"></span>
                    <button id="logout-btn" style="background-color: #ff4757;">Cerrar sesión</button>
                </div>
            </div>

            <div id="introduction-box" class="introduction-popup hidden">
                <div class="introduction-header">
                    <span class="intro-title">Welcome to Carbon Control</span>
                    <button class="close-button" onclick="closeIntroductionBox()">&times;</button>
                </div>
                <div class="divider"></div>
                <p class="introduction-text">
                    This platform is designed to monitor climate impact, encourage eco-friendly actions, and reward
                    sustainability efforts.

                    Instead of just telling you, let us show you! Watch this video to learn more about how Carbon
                    Control works and how you can be part of the change.
                </p>
                <div class="divider"></div>

                <div class="content-container">
                    <img src="/static/images/Pford.png" alt="Introduction" class="intro-photo">
                    <div class="video-container">
                        <video controls>
                            <source src="/static/videos/Carbon Control.mp4" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <!-- About the Creator Pop-up Box (Initially Hidden) -->
            <div id="about-box" class="about-popup hidden">
                <div class="about-header">
                    <img src="/static/images/IMG_3307.jpg" alt="Jorge" class="about-photo">
                    <span class="about-title">About the Creator</span>
                    <button class="close-button" onclick="closeAboutBox()">&times;</button>
                </div>
                <div class="divider"></div>
                <p class="about-text">
                    Hi, I'm Jorge, a first-year Aeronautical Engineering student with a deep passion
                    for sustainability, technology, and innovation. Beyond my studies, I enjoy learning new languages,
                    practicing athletics, and exploring ways to make a meaningful impact on the world.

                    Carbon Control was born from my desire to merge environmental responsibility with modern technology.
                    By creating Pford Credits, I aim to encourage and reward eco-friendly actions, making sustainability
                    both accessible and rewarding. Join the movement and help shape a greener future with us!
                </p>
                <div class="divider"></div>
                <!-- Botón de Contacto -->
                <a href="mailto:jorgecf29@hotmail.com?subject=Collaboration Request&body=Hi Jorge, I'd like to collaborate with you!"
                    class="contact-button">
                    Contact Me
                </a>
            </div>

            <!-- Y PEGA JUSTO DESPUÉS este código: -->
            <div id="auth-success-popup" class="introduction-popup hidden">
                <div class="introduction-header">
                    <span class="intro-title">¡Bienvenido a Pford Credits!</span>
                    <button class="close-button" onclick="closeAuthPopup()">&times;</button>
                </div>
                <div class="divider"></div>
                <p class="introduction-text" id="auth-message">
                    <!-- El mensaje se llenará dinámicamente -->
                </p>
                <div class="divider"></div>
                <button class="accept-button" onclick="closeAuthPopup()">Continuar</button>
            </div>

            <section id="container-2">
                <h3>Global Greenhouse Gas Emissions from 1958 - 2024</h3>
            </section>

            <section id="container-3">
                <div id="carbon-globe-container" style="display: none;">
                    <iframe id="carbon-globe" width="100%" height="400px" frameborder="0"></iframe>
                </div>
            </section>

            <section id="year-selection">
                <label for="year-select">Select year to visualize CO2 concentrations in the world</label>
                <select id="year-select">
                    <option value="">Select a year</option>
                    <script>
                        for (let year = 1958; year <= 2024; year++) {
                            document.write(`<option value="${year}">${year}</option>`);
                        }
                    </script>
                </select>
            </section>

            <!-- Sign-Up Pop-up Box (Initially Hidden) -->
            <div id="signup-box" class="disclaimer-box hidden">
                <div class="disclaimer-header">
                    <img src="/static/images/Pford_2.jpg" alt="Pford Logo" class="business-logo">
                    <span class="business-name">Welcome to Pford Credits</span>
                    <button class="close-button" onclick="closeSignupBox()">&times;</button>
                </div>
                <div class="divider"></div>
                <p class="disclaimer-text">
                    Hey! Pford Credits is here to reward your eco-friendly actions. Right now, it's only available for
                    students at the Universidad Aeronáutica en Querétaro, but we're growing fast. Soon, it'll be in
                    Querétaro and beyond—why not get ahead and start earning today?
                </p>
                <div class="divider"></div>
                <div class="input-container">
                    <label for="institutional-email">Institutional Email</label>
                    <input type="email" id="institutional-email" placeholder="example@soyunaq.mx">
                </div>

                <div class="input-container">
                    <label for="password">Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="password" placeholder="Enter your password">
                        <i class="fas fa-eye" id="toggle-password"
                            onclick="togglePassword('password', 'toggle-password')"></i>
                    </div>
                </div>

                <div class="input-container">
                    <label for="confirm-password">Confirm Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="confirm-password" placeholder="Confirm your password">
                        <i class="fas fa-eye" id="toggle-confirm-password"
                            onclick="togglePassword('confirm-password', 'toggle-confirm-password')"></i>
                    </div>
                </div>

                <div class="divider"></div>
                <button class="accept-button" onclick="submitSignup()">Sign Up</button>

                <!-- New Login Section -->
                <p class="login-text">Already have an account?</p>
                <p class="login-link"><a href="#" onclick="showLogin()">Log in</a></p>
            </div>

            <!-- Log In Pop-up Box (Initially Hidden) -->
            <div id="login-box" class="disclaimer-box hidden">
                <div class="disclaimer-header">
                    <img src="/static/images/Pford_2.jpg" alt="Pford Logo" class="business-logo">
                    <span class="business-name">Welcome Back to Pford Credits</span>
                    <button class="close-button" onclick="closeLoginBox()">&times;</button>
                </div>
                <div class="divider"></div>
                <p class="disclaimer-text">
                    Log in to your Pford Credits account to track your rewards and redeem them for benefits.
                </p>
                <div class="divider"></div>
                <div class="input-container">
                    <label for="login-email">Institutional Email</label>
                    <input type="email" id="login-email" placeholder="example@soyunaq.mx">
                </div>

                <div class="input-container">
                    <label for="login-password">Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="login-password" placeholder="Enter your password">
                        <i class="fas fa-eye" id="toggle-login-password"
                            onclick="togglePassword('login-password', 'toggle-login-password')"></i>
                    </div>
                </div>

                <div class="divider"></div>
                <button class="accept-button" onclick="submitLogin()">Log In</button>

                <!-- New Sign Up Section -->
                <p class="login-text">Don't have an account?</p>
                <p class="signup-link"><a href="#" onclick="showSignup()">Create one</a></p>
            </div>

            <header id="header">
                <div id="location-info">
                    <p>Camera: 35 km | Lat: <span id="lat">20.5831</span> | Lon: <span id="lon">-100.4267</span></p>
                </div>
            </header>

            <section id="info-above-map">
                <h3>Your Local Climate Impact</h3>
                <p>See How Climate Change is Affecting Your Region</p>
            </section>

            <section id="map-container">
                <div id="map"></div>
            </section>

            <section id="info-below-map">
                <div id="container-info-below-map">
                    <img src="/static/images/Pford.png" alt="Pford character explaining climate data"
                        class="pford-image" />
                    <div class="pford-info">
                        <p id="pford-message">
                            ¡Hola comunidad UNAQ! Mi nombre es Pford, y soy un asistente virtual diseñado para brindar
                            información sobre el medio ambiente en el estado de Querétaro. Pueden preguntarme cualquier
                            cosa acerca del clima, la contaminación, consejos para cuidar el planeta o incluso sobre
                            esta plataforma. Les responderé según la información disponible en mi base de datos.

                            Si desean apoyar con sugerencias, comentarios o contribuir con datos adicionales, pueden
                            hacerlo dando clic <a href="http://127.0.0.1:5000/" target="_blank"
                                style="color: #c2e7ff; text-decoration: underline;">aquí</a>.
                            ¡Juntos hagamos de Querétaro un lugar más sostenible!
                        </p>
                    </div>
                </div>
            </section>

            <div id="pford-chat-container">
                <input type="text" placeholder="Ask Pford..." id="pford-chat-input">
                <button id="pford-chat-button">
                    <i class="fas fa-paper-plane"></i> <!-- Paper airplane icon -->
                </button>
            </div>

            <div class="pford-info" id="chatOutput"></div>

        </main>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="/static/script.js"></script>
    <script src="CarbonGlobe/script.js"></script>

    <!-- Script for Pford Credits Hover Effect -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const creditsButton = document.getElementById("pford-credits-button");
            const popup = document.getElementById("pford-credits-box");

            // Toggle pop-up visibility on button click
            creditsButton.addEventListener("click", () => {
                popup.style.display = (popup.style.display === "block") ? "none" : "block";
            });

            // Close pop-up if clicking outside
            document.addEventListener("click", (event) => {
                if (!creditsButton.contains(event.target) && !popup.contains(event.target)) {
                    popup.style.display = "none";
                }
            });
        });

        // Hide loading video after it ends
        document.getElementById('loading-video').addEventListener('ended', function () {
            const videoOverlay = document.getElementById('video-overlay');
            videoOverlay.style.opacity = '0';
            setTimeout(function () {
                videoOverlay.style.display = 'none';
                document.body.classList.remove('hidden-content');
            }, 1000);
        });
    </script>

    <script>
        // Funciones para mostrar/ocultar popups
        function showLogin() {
            document.getElementById("signup-box").classList.add("hidden");
            document.getElementById("login-box").classList.remove("hidden");
        }

        function showSignup() {
            document.getElementById("login-box").classList.add("hidden");
            document.getElementById("signup-box").classList.remove("hidden");
        }

        function closeLoginBox() {
            document.getElementById("login-box").classList.add("hidden");
        }

        function closeSignupBox() {
            document.getElementById("signup-box").classList.add("hidden");
        }

        // Configuración de eventos
        document.addEventListener("DOMContentLoaded", function () {
            // Botón Sign Up en el menú principal
            document.getElementById("pford-credits-button").addEventListener("click", function (e) {
                e.stopPropagation(); // solo previene que se cierre el popup por clic externo
            });

            // Botón Sign Up dentro del popup de créditos
            document.querySelectorAll('.signup-button').forEach(button => {
                button.addEventListener('click', function (e) {
                    e.stopPropagation();
                    showSignup();
                });
            });

            // Enlaces "Log in"
            document.querySelectorAll('.login-link a, .login-text a').forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    showLogin();
                });
            });

            // Enlaces "Sign up"
            document.querySelectorAll('.signup-link a').forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    showSignup();
                });
            });

            // Cerrar popups al hacer clic fuera (modificado para no interferir)
            document.addEventListener('click', function (event) {
                const popups = document.querySelectorAll('.pford-popup:not(.hidden), .disclaimer-box:not(.hidden)');
                popups.forEach(popup => {
                    if (!popup.contains(event.target)) {
                        // Solo cerrar si no se hizo clic en ningún botón que pueda abrirlos
                        if (!event.target.closest('#pford-credits-button, .signup-button, .login-link a, .signup-link a')) {
                            popup.classList.add('hidden');
                        }
                    }
                });
            });
        });

        // El resto de tus funciones (submitSignup, submitLogin, checkSession, etc.) permanecen igual
        async function submitSignup() {
            const email = document.getElementById("institutional-email").value;
            const password = document.getElementById("password").value;
            const confirmPassword = document.getElementById("confirm-password").value;

            if (!email.endsWith('@soyunaq.mx')) {
                showAuthPopup('Error', 'Solo se permiten correos institucionales @soyunaq.mx', true);
                return;
            }

            if (password.length < 8) {
                showAuthPopup('Error', 'La contraseña debe tener al menos 8 caracteres', true);
                return;
            }

            if (password !== confirmPassword) {
                showAuthPopup('Error', 'Las contraseñas no coinciden', true);
                return;
            }

            try {
                const response = await fetch('/signup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (data.error) {
                    showAuthPopup('Error', data.error, true);
                } else {
                    showAuthPopup('¡Éxito!', `Bienvenido ${data.user.email}. Has ganado 10 créditos iniciales.`, false);
                    updateUIForLoggedInUser(data.user);
                    closeSignupBox();
                }
            } catch (error) {
                showAuthPopup('Error', 'Error de conexión. Intenta nuevamente.', true);
            }
        }

        async function submitLogin() {
            const email = document.getElementById("login-email").value;
            const password = document.getElementById("login-password").value;

            if (!email || !password) {
                showAuthPopup('Error', 'Por favor ingresa tu correo y contraseña', true);
                return;
            }

            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (data.error) {
                    showAuthPopup('Error', data.error, true);
                } else {
                    showAuthPopup('¡Bienvenido!', `Hola ${data.user.email}. Tienes ${data.user.credits} créditos.`, false);
                    updateUIForLoggedInUser(data.user);
                    closeLoginBox();
                }
            } catch (error) {
                showAuthPopup('Error', 'Error de conexión. Intenta nuevamente.', true);
            }
        }
    </script>

    <style>
        .password-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .password-wrapper input {
            flex: 1;
            padding-right: 30px;
        }

        .password-wrapper i {
            position: absolute;
            right: 10px;
            cursor: pointer;
            color: #888;
        }
    </style>

    <script>
        function togglePassword(inputId, iconId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(iconId);
            if (input.type === "password") {
                input.type = "text";
                icon.classList.remove("fa-eye");
                icon.classList.add("fa-eye-slash");
            } else {
                input.type = "password";
                icon.classList.remove("fa-eye-slash");
                icon.classList.add("fa-eye");
            }
        }
    </script>

    <script>
        function checkSession() {
            fetch('/check_session')
                .then(response => response.json())
                .then(data => {
                    if (data.logged_in && data.user) {
                        updateUIForLoggedInUser(data.user);
                    }
                })
                .catch(error => console.error('Error verificando sesión:', error));
        }

        function showAuthPopup(title, message, isError) {
            document.getElementById("auth-success-popup").classList.remove("hidden");
            document.querySelector("#auth-success-popup .intro-title").textContent = title;
            document.getElementById("auth-message").textContent = message;

            if (isError) {
                document.querySelector("#auth-success-popup .accept-button").style.backgroundColor = "#ff4757";
            } else {
                document.querySelector("#auth-success-popup .accept-button").style.backgroundColor = "purple";
            }
        }

        function closeAuthPopup() {
            document.getElementById("auth-success-popup").classList.add("hidden");
        }

        function updateUIForLoggedInUser(user) {
            // Mostrar información del usuario
            const userMenu = document.getElementById("user-menu");
            const creditsButton = document.getElementById("pford-credits-button");

            if (userMenu && creditsButton) {
                userMenu.style.display = "block";
                creditsButton.style.display = "none";
                document.getElementById("user-email-display").textContent = user.email;

                // Actualizar créditos en el popup del logo
                if (document.getElementById("popup-user-email")) {
                    document.getElementById("popup-user-email").textContent = `Correo: ${user.email}`;
                    document.getElementById("popup-user-credits").textContent = `Créditos: ${user.credits}`;
                }
            }

            // Actualizar el botón de créditos si existe
            const pfordCreditsBtn = document.getElementById("pford-credits-button");
            if (pfordCreditsBtn) {
                pfordCreditsBtn.textContent = `${user.credits} Créditos`;
            }
        }

        document.getElementById("logout-btn")?.addEventListener("click", function () {
            fetch('/logout')
                .then(response => response.json())
                .then(data => {
                    showAuthPopup('Sesión cerrada', 'Has cerrado sesión exitosamente', false);
                    document.getElementById("user-menu").style.display = "none";
                    document.getElementById("pford-credits-button").style.display = "block";
                    document.getElementById("pford-credits-button").textContent = "Sign up";

                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                })
                .catch(error => {
                    showAuthPopup('Error', 'No se pudo cerrar la sesión', true);
                });
        });

        // Verificar sesión al cargar la página
        checkSession();
    </script>

    <script>
        function showAboutBox() {
            document.getElementById("about-box").classList.remove("hidden");
        }

        function closeAboutBox() {
            document.getElementById("about-box").classList.add("hidden");
        }

        document.addEventListener("DOMContentLoaded", function () {
            document.querySelector("#menu button:nth-child(6)").addEventListener("click", function () {
                showAboutBox();
            });
        });

        // En el evento DOMContentLoaded, agrega esto:
        document.addEventListener('DOMContentLoaded', function () {
            const topMenu = document.getElementById('top-menu');
            topMenu.style.width = '100%';
            topMenu.style.left = '0';
        });
    </script>

    <script>
        function showIntroductionBox() {
            document.getElementById("introduction-box").classList.remove("hidden");
        }

        function closeIntroductionBox() {
            document.getElementById("introduction-box").classList.add("hidden");
        }
    </script>

    <style>
        .introduction-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50%;
            background: rgba(30, 30, 30, 0.95);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 0px 15px rgba(128, 0, 128, 0.5);
            color: white;
            z-index: 10000;
            text-align: center;
        }

        .introduction-header {
            display: flex;
            align-items: center;
            justify-content: center;
            /* Centra el título */
        }

        .intro-title {
            font-size: 38px;
            text-align: center;
            font-weight: bold;
            color: white;
            display: block;
            width: 100%;
        }

        .divider {
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.7);
        }

        /* Nueva clase para organizar la imagen y el video */
        .content-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            /* Espacio entre imagen y video */
        }

        .intro-photo {
            width: 200px;
            height: auto;
            border-radius: 10px;
        }

        .video-container {
            display: flex;
            justify-content: flex-end;
            /* Alinea el video a la derecha */
            width: 100%;
            max-width: 700px;
        }

        .video-container video {
            width: 100%;
            max-width: 650px;
            border-radius: 10px;
        }
    </style>

    <script>
        document.getElementById("toggle-live-data").addEventListener("click", function () {
            var container = document.getElementById("carbon-globe-container");
            var iframe = document.getElementById("carbon-globe");

            if (container.style.display === "none") {
                container.style.display = "block";
                iframe.src = "{{ url_for('static', filename='CarbonGlobe/CarbonGlobe.html') }}";

                // Ajustar el tamaño del iframe después de cargar
                setTimeout(() => {
                    iframe.style.width = "100%";
                    iframe.style.height = "300px"; // Ajusta según la altura del contenedor
                }, 500); // Espera medio segundo para asegurar la carga correcta
            } else {
                container.style.display = "none";
                iframe.src = ""; // Detener la animación para liberar memoria
            }
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const toggleBtn = document.getElementById('sidebar-toggle');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('main');
            const topMenu = document.getElementById('top-menu');

            toggleBtn.addEventListener('click', function () {
                sidebar.classList.toggle('sidebar-collapsed');
                mainContent.classList.toggle('main-expanded');

                // Ajustar el ancho del top-menu
                if (sidebar.classList.contains('sidebar-collapsed')) {
                    topMenu.style.width = '100%';
                    topMenu.style.left = '0';
                } else {
                    topMenu.style.width = 'calc(100% - 300px)';
                    topMenu.style.left = '300px';
                }
            });
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const logoImg = document.querySelector(".logo");
            const popup = document.getElementById("user-credit-popup");

            logoImg.addEventListener("click", () => {
                if (sessionStorage.getItem("userEmail")) {
                    // Llenar datos
                    document.getElementById("popup-user-email").textContent = `Correo: ${sessionStorage.getItem("userEmail")}`;
                    document.getElementById("popup-user-credits").textContent = `Créditos: ${sessionStorage.getItem("userCredits")}`;
                    popup.classList.toggle("hidden");
                }
            });

            // Cerrar si haces clic fuera
            document.addEventListener("click", (e) => {
                if (!popup.contains(e.target) && !logoImg.contains(e.target)) {
                    popup.classList.add("hidden");
                }
            });
        });

        // Cerrar popups al hacer clic fuera de ellos
        document.addEventListener('click', function (event) {
            const popups = document.querySelectorAll('.pford-popup:not(.hidden), .disclaimer-box:not(.hidden)');
            popups.forEach(popup => {
                if (!popup.contains(event.target) &&
                    !event.target.matches('#pford-credits-button, #pford-credits-button *, #logout-btn, #logout-btn *')) {
                    popup.classList.add('hidden');
                }
            });
        });
    </script>

    <script>
        // Muestra el popup de redeem
        function showRedeemPopup() {
            // Verificar si el usuario está logeado
            fetch('/check_session')
                .then(response => response.json())
                .then(data => {
                    if (data.logged_in) {
                        document.getElementById("redeem-popup").classList.remove("hidden");
                        // Resetear el formulario
                        document.getElementById("action-description").value = "";
                        document.getElementById("action-image").value = "";
                        document.getElementById("redeem-success").style.display = "none";
                    } else {
                        showAuthPopup('Error', 'Debes iniciar sesión para canjear acciones', true);
                    }
                });
        }

        function closeRedeemPopup() {
            document.getElementById("redeem-popup").classList.add("hidden");
        }

        function submitRedeemAction() {
            const description = document.getElementById("action-description").value;
            const imageFile = document.getElementById("action-image").files[0];

            if (!description || !imageFile) {
                showAuthPopup('Error', 'Por favor completa todos los campos', true);
                return;
            }

            const formData = new FormData();
            formData.append('description', description);
            formData.append('image', imageFile);

            fetch('/redeem_action', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Mostrar animación de éxito
                        document.getElementById("redeem-success").style.display = "block";
                        // Ocultar después de 3 segundos
                        setTimeout(() => {
                            closeRedeemPopup();
                        }, 3000);
                    } else {
                        showAuthPopup('Error', data.error || 'Error al enviar la evidencia', true);
                    }
                })
                .catch(error => {
                    showAuthPopup('Error', 'Error de conexión', true);
                });
        }

        // Agrega el event listener al botón
        document.getElementById("redeem-actions-btn")?.addEventListener("click", showRedeemPopup);
    </script>

    <script>
        // Funciones para Report Actions
        function showReportPopup() {
            const popup = document.getElementById("report-popup");
            const loginMessage = document.getElementById("report-login-message");
            const reportForm = document.getElementById("report-form");

            // Verificar si el usuario está logeado
            fetch('/check_session')
                .then(response => response.json())
                .then(data => {
                    if (data.logged_in) {
                        loginMessage.style.display = "none";
                        reportForm.style.display = "block";
                        // Resetear el formulario
                        document.getElementById("report-description").value = "";
                        document.getElementById("report-image").value = "";
                        popup.classList.remove("hidden");
                    } else {
                        loginMessage.style.display = "block";
                        reportForm.style.display = "none";
                        popup.classList.remove("hidden");
                        showAuthPopup('Error', 'Debes iniciar sesión para reportar acciones', true);
                    }
                })
                .catch(error => {
                    console.error('Error verificando sesión:', error);
                });
        }

        function closeReportPopup() {
            document.getElementById("report-popup").classList.add("hidden");
        }

        function submitReportAction() {
            const description = document.getElementById("report-description").value;
            const imageFile = document.getElementById("report-image").files[0];

            if (!description || !imageFile) {
                showAuthPopup('Error', 'Por favor completa todos los campos', true);
                return;
            }

            const formData = new FormData();
            formData.append('description', description);
            formData.append('image', imageFile);

            fetch('/report_action', {  // Cambiado a '/report_action'
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAuthPopup('Éxito', data.message || '¡Acción reportada con éxito! Se verificará pronto.', false);
                        closeReportPopup();
                    } else {
                        showAuthPopup('Error', data.error || 'Error al enviar el reporte', true);
                    }
                })
                .catch(error => {
                    showAuthPopup('Error', 'Error de conexión: ' + error.message, true);
                });
        }

        // Asignar el event listener correctamente
        document.addEventListener("DOMContentLoaded", function () {
            const reportBtn = document.getElementById("report-actions-btn");
            if (reportBtn) {
                reportBtn.addEventListener("click", function (e) {
                    e.stopPropagation();
                    showReportPopup();
                });
            }
        });
    </script>

</body>

</html>
