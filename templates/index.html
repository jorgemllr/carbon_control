<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carbon Control</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>

<body class="hidden-content">

    <!-- Contenedor para el video de carga -->
    <div id="video-overlay">
        <video autoplay muted playsinline id="loading-video">
            <source src="/static/videos/Intro.mp4" type="video/mp4">
            Tu navegador no admite la etiqueta de video.
        </video>
    </div>

    <!-- Contenido de la p√°gina -->
    <div id="container">
        <aside id="sidebar" class="sidebar-collapsed"> <!-- Agrega class="sidebar-collapsed" aqu√≠ -->
            <div id="search-container">
                <input type="text" placeholder="Buscar ciudad..." id="search-bar">
                <i class="fas fa-search search-icon" style="color: #c4c7c5;"></i>
            </div>

            <!-- Agrega esta secci√≥n de perfil de usuario al principio -->
            <div id="user-profile-sidebar">
                <img src="/static/images/Pford_2.jpg" alt="User Photo" id="sidebar-user-photo"
                    class="sidebar-user-photo">
                <div id="sidebar-user-name" class="sidebar-user-name"></div> <!-- Nueva l√≠nea para el nombre -->
                <div id="sidebar-login-text" class="sidebar-login-text">Iniciar sesi√≥n</div>
                <div id="sidebar-user-info" class="sidebar-user-info hidden">
                    <div id="sidebar-user-email"></div>
                    <div id="sidebar-user-credits"></div>
                </div>
            </div>

            <div id="menu">
                <button>Tabla de Posiciones</button>
                <button onclick="showIntroductionBox()">Introducci√≥n</button>
                <button onclick="showShareBox()">Comparte y Gana Cr√©ditos</button>
                <button onclick="showAboutBox()">Sobre el Creador</button>
            </div>
            <div id="info">Monitorea tus acciones ecol√≥gicas, gana recompensas y ayuda al planeta.</div>
        </aside>

        <main class="main-expanded"> <!-- Agrega class="main-expanded" aqu√≠ -->
            <div id="top-menu">
                <button id="sidebar-toggle" class="toggle-btn">
                    <i class="fas fa-bars"></i>
                </button>
                <img src="{{ url_for('static', filename='images/Pford_2.jpg') }}" alt="Carbon Control Logo"
                    class="logo">

                <!-- Pop-up con cr√©ditos del usuario (correo y puntos) -->
                <div id="user-credit-popup" class="pford-popup hidden">
                    <div class="popup-header">
                        <img src="/static/images/Pford_2.jpg" alt="Pford Icon" class="pford-icon">
                        <span class="popup-title">Tus Cr√©ditos</span>
                    </div>
                    <div class="popup-divider"></div>
                    <p id="popup-user-email" class="popup-text"></p>
                    <p id="popup-user-credits" class="popup-text"></p>
                </div>

                <!-- Acciones Pop-up Box (Initially Hidden) -->
                <div id="actions-popup" class="actions-popup hidden" style="display: none;">
                    <div class="actions-header">
                        <img src="/static/images/Pford_2.jpg" alt="Pford Icon" class="pford-icon">
                        <span class="actions-title">Eco-Acciones</span>
                        <button class="close-button" onclick="closeActionsPopup()">&times;</button>
                    </div>
                    <div class="popup-divider"></div>
                    <div class="actions-table-container">
                        <table class="actions-table">
                            <thead>
                                <tr>
                                    <th>Categor√≠a</th>
                                    <th>Acci√≥n sustentable</th>
                                    <th>Evidencia requerida</th>
                                    <th>Cr√©ditos</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>‚ôªÔ∏è Reciclaje visible</td>
                                    <td>Depositar PET/latas en los contenedores correctos</td>
                                    <td>Foto del dep√≥sito en el contenedor</td>
                                    <td>üü¢ 50 cr√©ditos</td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <td>Llevar papel usado al contenedor de reciclaje</td>
                                    <td>Foto del dep√≥sito con papel</td>
                                    <td>üü¢ 50 cr√©ditos</td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <td>Separar residuos correctamente en estaciones de separaci√≥n</td>
                                    <td>Foto del uso correcto</td>
                                    <td>üü¢ 50 cr√©ditos</td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <td>Llevar botellas o tapas a centros de acopio de la UNAQ</td>
                                    <td>Foto entregando material</td>
                                    <td>üü¢ 75 cr√©ditos</td>
                                </tr>
                                <tr>
                                    <td>üß¥ Reducci√≥n de pl√°sticos</td>
                                    <td>Usar termo personal en vez de botella desechable</td>
                                    <td>Foto del termo en uso</td>
                                    <td>üü¢ 50 cr√©ditos</td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <td>Llevar alimentos en recipientes reutilizables</td>
                                    <td>Foto del recipiente</td>
                                    <td>üü¢ 50 cr√©ditos</td>
                                </tr>
                                <tr>
                                    <td>üßΩ Limpieza y orden</td>
                                    <td>Recoger basura en salones o √°reas comunes (m√≠nimo 5 piezas)</td>
                                    <td>Foto antes y despu√©s</td>
                                    <td>üü¢ 75 cr√©ditos</td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <td>Limpiar mesas o bancos con material ecol√≥gico</td>
                                    <td>Foto del material y √°rea limpia</td>
                                    <td>üü¢ 50 cr√©ditos</td>
                                </tr>
                                <tr>
                                    <td>üì¢ Educaci√≥n ecol√≥gica</td>
                                    <td>Asistir a pl√°tica/taller ecol√≥gico organizado por la escuela</td>
                                    <td>Foto del evento o captura de registro</td>
                                    <td>üü¢ 100 cr√©ditos</td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <td>Colocar cartel ecol√≥gico informativo en la escuela</td>
                                    <td>Foto del cartel en muro o pizarr√≥n</td>
                                    <td>üü¢ 75 cr√©ditos</td>
                                </tr>
                                <tr>
                                    <td>üß† Creatividad verde</td>
                                    <td>Dise√±ar y presentar una infograf√≠a ecol√≥gica para difundir</td>
                                    <td>Foto del dise√±o pegado o compartido</td>
                                    <td>üü¢ 100 cr√©ditos</td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <td>Participar en un concurso o actividad ecol√≥gica institucional</td>
                                    <td>Foto del momento o diploma</td>
                                    <td>üü¢ 125 cr√©ditos</td>
                                </tr>
                                <tr>
                                    <td>üóëÔ∏è Mantenimiento ecol√≥gico</td>
                                    <td>Reportar contenedor lleno o mal uso del reciclaje</td>
                                    <td>Foto clara del incidente</td>
                                    <td>üü¢ 25 cr√©ditos</td>
                                </tr>
                                <tr>
                                    <td>üå≥ Acci√≥n ecol√≥gica directa</td>
                                    <td>Regar plantas de √°reas verdes comunes (solo con permiso)</td>
                                    <td>Foto con regadera y zona regada</td>
                                    <td>üü¢ 50 cr√©ditos</td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <td>Cuidar o limpiar una zona verde de la escuela</td>
                                    <td>Foto antes y despu√©s</td>
                                    <td>üü¢ 75 cr√©ditos</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Leaderboard Pop-up Box (Initially Hidden) -->
                <div id="leaderboard-popup" class="actions-popup hidden">
                    <div class="leaderboard-header">
                        <img src="/static/images/Pford_2.jpg" alt="Pford Icon" class="pford-icon">
                        <span class="leaderboard-title">Tabla de Posiciones</span>
                        <button class="close-button" onclick="closeLeaderboardPopup()">&times;</button>
                    </div>
                    <div class="popup-divider"></div>
                    <div class="leaderboard-table-container">
                        <table class="leaderboard-table">
                            <thead>
                                <tr>
                                    <th>Posici√≥n</th>
                                    <th>Usuario</th>
                                    <th>Cr√©ditos</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboard-body">
                                <!-- Los usuarios se cargar√°n aqu√≠ din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Report Actions Pop-up Box (Initially Hidden) -->
                <div id="report-popup" class="actions-popup hidden">
                    <div class="actions-header">
                        <img src="/static/images/Pford_2.jpg" alt="Pford Icon" class="pford-icon">
                        <span class="actions-title">Reportar Acci√≥n Ecol√≥gica</span>
                        <button class="close-button"
                            onclick="closeReportPopup(); event.stopPropagation();">&times;</button>
                    </div>
                    <div class="popup-divider"></div>

                    <div class="input-container" style="padding: 20px;">
                        <label for="action-type">Tipo de acci√≥n:</label>
                        <select id="action-type" class="actions-select">
                            <option value="">Selecciona una acci√≥n</option>
                            <option value="reciclaje_pet">‚ôªÔ∏è Reciclaje visible (PET/latas) - 50 cr√©ditos</option>
                            <option value="reciclaje_papel">‚ôªÔ∏è Reciclaje visible (Papel) - 50 cr√©ditos</option>
                            <option value="separacion_residuos">‚ôªÔ∏è Separaci√≥n de residuos - 50 cr√©ditos</option>
                            <option value="centro_acopio">‚ôªÔ∏è Centro de acopio UNAQ - 75 cr√©ditos</option>
                            <option value="reduccion_termo">üß¥ Reducci√≥n de pl√°sticos (Termo) - 50 cr√©ditos</option>
                            <option value="reduccion_recipientes">üß¥ Reducci√≥n de pl√°sticos (Recipientes) - 50 cr√©ditos
                            </option>
                            <option value="limpieza_basura">üßΩ Limpieza (Recoger basura) - 75 cr√©ditos</option>
                            <option value="limpieza_mesas">üßΩ Limpieza (Mesas/bancos) - 50 cr√©ditos</option>
                            <option value="platica_ecologica">üì¢ Educaci√≥n ecol√≥gica (Pl√°tica/taller) - 100 cr√©ditos
                            </option>
                            <option value="cartel_ecologico">üì¢ Educaci√≥n ecol√≥gica (Cartel) - 75 cr√©ditos</option>
                            <option value="infografia">üß† Creatividad verde (Infograf√≠a) - 100 cr√©ditos</option>
                            <option value="concurso_ecologico">üß† Creatividad verde (Concurso) - 125 cr√©ditos</option>
                            <option value="reporte_contenedor">üóëÔ∏è Reporte de contenedor - 25 cr√©ditos</option>
                            <option value="riego_plantas">üå≥ Riego de plantas - 50 cr√©ditos</option>
                            <option value="limpieza_verde">üå≥ Limpieza zona verde - 75 cr√©ditos</option>
                            <option value="otro">Otro (Especificar abajo)</option>
                        </select>

                        <div id="other-action-container" class="hidden" style="margin-top: 15px;">
                            <label for="other-action">Describe tu acci√≥n:</label>
                            <textarea id="other-action" rows="3" style="width: 100%; padding: 8px;"></textarea>
                            <p style="font-size: 12px; color: #aaa;">Cr√©ditos pendientes de aprobaci√≥n</p>
                        </div>

                        <div style="margin-top: 15px;">
                            <label for="report-image">Sube una foto como evidencia:</label>
                            <input type="file" id="report-image" accept="image/*" style="margin-top: 5px;">
                        </div>

                        <div style="margin-top: 20px; text-align: center;">
                            <button class="actions-table-button" onclick="submitReportAction()" style="width: 100%;">
                                Enviar Reporte
                            </button>
                        </div>
                    </div>
                </div>

                <button id="actions-btn">Eco-Acciones</button>
                <button id="toggle-live-data">CO‚ÇÇ Global</button>
                <!-- Busca el bot√≥n de reportar en tu HTML y reempl√°zalo con este: -->
                <button id="report-actions-btn">Iniciar sesi√≥n</button>

                <!-- Pford Credits Button with Clickable Pop-up -->
                <div id="pford-credits-container">
                    <button id="pford-credits-button">Registrarse</button>
                    <!-- Pop-up Box (Initially Hidden) -->
                    <div id="pford-credits-box" class="pford-popup">
                        <div class="popup-header">
                            <img src="/static/images/Pford_2.jpg" alt="Pford Icon" class="pford-icon">
                            <span class="popup-title">Pford Credits</span>
                        </div>
                        <div class="popup-divider"></div>
                        <p class="popup-text">
                            Los Pford Credits son tu recompensa por acciones ecol√≥gicas en el campus.
                            Acum√∫lalos y descubre los beneficios disponibles para ti.
                            ¬°Cada acci√≥n cuenta para un futuro m√°s sostenible!
                        </p>
                        <div class="popup-divider"></div>
                        <button class="signup-button">Registrarse</button>

                        <!-- New Login Section -->
                        <p class="login-text-small">¬øYa tienes una cuenta?</p>
                        <p class="login-link"><a href="#" onclick="showLogin()">Iniciar sesi√≥n</a></p>
                    </div>
                </div>
            </div>

            <div id="introduction-box" class="introduction-popup hidden">
                <div class="introduction-header">
                    <span class="intro-title">¬°Bienvenido a Pford Credits!</span>
                    <button class="close-button" onclick="closeIntroductionBox()">&times;</button>
                </div>
                <div class="divider"></div>
                <p class="introduction-text">
                    √önete al programa de sostenibilidad UNAQ: mide tus acciones ecol√≥gicas, gana recompensas y ayuda al
                    campus. Conoce el sistema en este video:
                </p>
                <div class="divider"></div>

                <div class="content-container">
                    <img src="/static/images/Pford.png" alt="Introduction" class="intro-photo">
                    <div class="video-container">
                        <video controls>
                            <source src="/static/videos/Carbon Control.mp4" type="video/mp4">
                            Tu navegador no admite la etiqueta de video.
                        </video>
                    </div>
                </div>
            </div>

            <!-- About the Creator Pop-up Box (Initially Hidden) -->
            <div id="about-box" class="about-popup hidden">
                <div class="about-header">
                    <img src="/static/images/LinkedIn_BW.jpg" alt="Jorge" class="about-photo">
                    <span class="about-title">Sobre el Creador</span>
                    <button class="close-button" onclick="closeAboutBox()">&times;</button>
                </div>
                <div class="divider"></div>
                <div class="about-content-container"> <!-- Nuevo contenedor para el scroll -->
                    <div class="about-text">
                        <p>Hola, soy Jorge. Estudio Ingenier√≠a Aeron√°utica y me apasiona crear soluciones tecnol√≥gicas
                            con impacto ambiental positivo. Pford Credits naci√≥ como una forma de combinar mi inter√©s
                            por la sostenibilidad con mi gusto por automatizar procesos.</p>

                        <p>Fuera del c√≥digo, me gusta leer ‚Äîintento terminar al menos un libro por semana‚Äî y escuchar
                            m√∫sica. Soy fan de Frank Sinatra, Phil Collins, la m√∫sica cl√°sica‚Ä¶ y tambi√©n del buen rock.
                        </p>

                        <p>Adem√°s del desarrollo web y la inteligencia artificial, me interesan el golf, las artes
                            marciales y, por alguna raz√≥n, tengo debilidad por Ralph Lauren. Hablo siete idiomas; este
                            a√±o estuve estudiando japon√©s y ruso, aunque mi favorito sigue siendo el alem√°n. Si todo
                            sale bien, pronto empezar√© con mandar√≠n.</p>

                        <p>Si quieres saber m√°s sobre m√≠ o conocer otros proyectos en los que he trabajado, puedes
                            visitar mi portafolio al final de esta secci√≥n.</p>

                        <p>Gracias por formar parte de esta iniciativa ecol√≥gica.</p>
                    </div>
                </div>
                <div class="divider"></div>
                <!-- Bot√≥n de Contacto -->
                <a href="mailto:jorgemllr@outlook.com?subject=Collaboration Request&body=Hi Jorge, I'd like to collaborate with you!"
                    class="contact-button">
                    Cont√°ctame
                </a>
                <!-- Nuevo Bot√≥n de Portafolio -->
                <a href="https://leeddynamics.meslatt.com/" target="_blank" class="portfolio-button">
                    Portafolio
                </a>
            </div>

            <!-- Y PEGA JUSTO DESPU√âS este c√≥digo: -->
            <div id="auth-success-popup" class="introduction-popup hidden">
                <div class="introduction-header">
                    <span class="intro-title">¬°Bienvenido a Pford Credits!</span>
                    <button class="close-button" onclick="closeAuthPopup()">&times;</button>
                </div>
                <div class="divider"></div>
                <p class="introduction-text" id="auth-message">
                    <!-- El mensaje se llenar√° din√°micamente -->
                </p>
                <div class="divider"></div>
                <button class="accept-button" onclick="closeAuthPopup()">Continuar</button>
            </div>

            <section id="container-2" style="display: none;">
                <h3>Emisiones Globales de Gases de Efecto Invernadero (1958 - 2024)</h3>
            </section>

            <section id="container-3">
                <div id="carbon-globe-container" style="display: none;">
                    <iframe id="carbon-globe" width="100%" height="400px" frameborder="0"></iframe>
                </div>
            </section>

            <section id="year-selection" style="display: none;">
                <label for="year-select">Selecciona el a√±o para visualizar concentraciones de CO‚ÇÇ en el
                    mundo</label>
                <select id="year-select">
                    <option value="">Selecciona un a√±o</option>
                    <script>
                        for (let year = 1958; year <= 2024; year++) {
                            document.write(`<option value="${year}">${year}</option>`);
                        }
                    </script>
                </select>
            </section>

            <!-- Sign-Up Pop-up Box (Initially Hidden) -->
            <div id="signup-box" class="disclaimer-box hidden">
                <div class="disclaimer-header">
                    <img src="/static/images/Pford_2.jpg" alt="Pford Logo" class="business-logo">
                    <span class="business-name">Bienvenido/a a Pford Credits</span>
                    <button class="close-button" onclick="closeSignupBox()">&times;</button>
                </div>
                <div class="divider"></div>
                <p class="disclaimer-text">
                    √önete a la comunidad UNAQ que est√° transformando acciones ecol√≥gicas en recompensas reales. ¬°Tus
                    esfuerzos por el planeta merecen cr√©ditos!
                </p>
                <div class="divider"></div>
                <div class="input-container">
                    <label for="user-name">Nombre completo</label>
                    <input type="text" id="user-name" placeholder="Ingresa tu nombre completo">
                </div>

                <div class="input-container">
                    <label for="institutional-email">Correo institucional</label>
                    <input type="email" id="institutional-email" placeholder="ejemplo@soyunaq.mx">
                </div>

                <div class="input-container">
                    <label for="password">Contrase√±a</label>
                    <div class="password-wrapper">
                        <input type="password" id="password" placeholder="Ingresa tu contrase√±a">
                        <i class="fas fa-eye" id="toggle-password"
                            onclick="togglePassword('password', 'toggle-password')"></i>
                    </div>
                </div>

                <div class="input-container">
                    <label for="confirm-password">Confirmar contrase√±a</label>
                    <div class="password-wrapper">
                        <input type="password" id="confirm-password" placeholder="Confirmar contrase√±a">
                        <i class="fas fa-eye" id="toggle-confirm-password"
                            onclick="togglePassword('confirm-password', 'toggle-confirm-password')"></i>
                    </div>
                </div>

                <div class="divider"></div>
                <button class="accept-button" onclick="submitSignup()">Registrarse</button>

                <!-- New Login Section -->
                <p class="login-text">¬øYa tienes una cuenta?</p>
                <p class="login-link"><a href="#" onclick="showLogin()">Iniciar sesi√≥n</a></p>
            </div>

            <!-- Log In Pop-up Box (Initially Hidden) -->
            <div id="login-box" class="disclaimer-box hidden">
                <div class="disclaimer-header">
                    <img src="/static/images/Pford_2.jpg" alt="Pford Logo" class="business-logo">
                    <span class="business-name">¬°Bienvenido/a de vuelta a Pford Credits!</span>
                    <button class="close-button" onclick="closeLoginBox()">&times;</button>
                </div>
                <div class="divider"></div>
                <p class="disclaimer-text">
                    Inicia sesi√≥n en tu cuenta Pford Credits para ver tus recompensas y canjearlas por beneficios.
                </p>
                <div class="divider"></div>
                <div class="input-container">
                    <label for="login-email">Correo institucional</label>
                    <input type="email" id="login-email" placeholder="ejemplo@soyunaq.mx">
                </div>

                <div class="input-container">
                    <label for="login-password">Contrase√±a</label>
                    <div class="password-wrapper">
                        <input type="password" id="login-password" placeholder="Ingresa tu contrase√±a">
                        <i class="fas fa-eye" id="toggle-login-password"
                            onclick="togglePassword('login-password', 'toggle-login-password')"></i>
                    </div>
                </div>

                <div class="divider"></div>
                <button class="accept-button" onclick="submitLogin()">Iniciar sesi√≥n</button>

                <!-- New Sign Up Section -->
                <p class="login-text">¬øA√∫n no tienes cuenta?</p>
                <p class="signup-link"><a href="#" onclick="showSignup()">Reg√≠strate aqu√≠</a></p>
            </div>

            <!-- <header id="header">
                <div id="location-info">
                    <p>Camera: 35 km | Lat: <span id="lat">20.5831</span> | Lon: <span id="lon">-100.4267</span></p>
                </div>
            </header> -->

            <!-- <section id="info-above-map">
                <h3>Tu impacto clim√°tico local</h3>
                <p>Descubre c√≥mo el cambio clim√°tico afecta tu regi√≥n</p>
            </section> -->

            <section id="map-container">
                <div id="map-header">
                    <h3>Tu impacto clim√°tico local</h3>
                    <p>Descubre c√≥mo el cambio clim√°tico afecta tu regi√≥n</p>
                </div>
                <div id="map"></div>
                <!-- Nuevo contenedor para el control de c√°mara -->
                <div id="camera-control">
                    <button id="toggle-camera-info">
                        <i class="fas fa-chevron-down"></i> Informaci√≥n de C√°mara
                    </button>
                    <div id="camera-info" class="hidden">
                        <p>Camera: 35 km | Lat: <span id="lat">20.5831</span> | Lon: <span id="lon">-100.4267</span>
                        </p>
                    </div>
                </div>
            </section>

            <section id="info-below-map">
                <div id="container-info-below-map">
                    <img src="/static/images/Pford.png" alt="Pford character explaining climate data"
                        class="pford-image" />
                    <div class="pford-info">
                        <p id="pford-message">
                            ¬°Hola UNAQ! Soy Pford, tu asistente ambiental virtual. Puedes consultarme sobre clima,
                            contaminaci√≥n o c√≥mo cuidar el planeta en Quer√©taro.

                            <a href="http://127.0.0.1:5000/" target="_blank"
                                style="color: #c2e7ff; text-decoration: underline;">D√©janos tus sugerencias</a> para
                            mejorar juntos nuestro entorno.
                        </p>
                    </div>
                </div>
            </section>

            <div id="pford-chat-container">
                <input type="text" placeholder="Ask Pford..." id="pford-chat-input">
                <button id="pford-chat-button">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>

            <div class="pford-info" id="chatOutput"></div>

        </main>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="/static/script.js"></script>
    <script src="CarbonGlobe/script.js"></script>

    <!-- Script for Pford Credits Hover Effect -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const creditsButton = document.getElementById("pford-credits-button");
            const popup = document.getElementById("pford-credits-box");

            // Evento modificado para el bot√≥n dual (Registrarse/Cerrar sesi√≥n)
            creditsButton.addEventListener("click", function (e) {
                if (creditsButton.textContent === "Registrarse") {
                    e.stopPropagation();
                    popup.style.display = (popup.style.display === "block") ? "none" : "block";
                }
                // Si dice "Cerrar sesi√≥n", el onclick asignado en updateUIForLoggedInUser manejar√° el logout
            });

            // Mant√©n este cierre del popup al hacer clic fuera
            document.addEventListener("click", (event) => {
                if (!creditsButton.contains(event.target) && !popup.contains(event.target)) {
                    popup.style.display = "none";
                }
            });
        });

        // Verificar datos de sesi√≥n al cargar la p√°gina
        document.addEventListener("DOMContentLoaded", function () {
            // Mostrar datos guardados mientras se verifica con el servidor
            const savedEmail = sessionStorage.getItem("userEmail");
            const savedCredits = sessionStorage.getItem("userCredits");
            const savedName = sessionStorage.getItem("userName");

            if (savedEmail) {
                const userData = {
                    email: savedEmail,
                    credits: savedCredits || "0",
                    name: savedName || savedEmail.split('@')[0]
                };
                updateUIForLoggedInUser(userData);
            }

            // Luego verificar con el servidor
            checkSession();
        });

        // Hide loading video after it ends
        document.getElementById('loading-video').addEventListener('ended', function () {
            const videoOverlay = document.getElementById('video-overlay');
            videoOverlay.style.opacity = '0';
            setTimeout(function () {
                videoOverlay.style.display = 'none';
                document.body.classList.remove('hidden-content');
            }, 1000);
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Configurar el evento de clic para el bot√≥n de login en el sidebar
            const sidebarLoginBtn = document.getElementById("sidebar-login-text");
            if (sidebarLoginBtn) {
                sidebarLoginBtn.addEventListener("click", function (e) {
                    e.stopPropagation();
                    showLogin();
                });
            }

            // Tambi√©n puedes hacer que toda el √°rea del perfil de usuario sea clickeable
            const userProfileSidebar = document.getElementById("user-profile-sidebar");
            if (userProfileSidebar) {
                userProfileSidebar.addEventListener("click", function () {
                    // Verificar si el usuario no est√° logueado
                    fetch('/check_session')
                        .then(response => response.json())
                        .then(data => {
                            if (!data.logged_in) {
                                showLogin();
                            }
                        });
                });
            }
        });
    </script>

    <script>
        // Reemplaza el c√≥digo actual con este:
        function showActionsPopup() {
            document.getElementById("actions-popup").style.display = "flex"; // Usamos flex para mantener el layout
            document.getElementById("actions-popup").classList.remove("hidden");
        }

        function closeActionsPopup() {
            document.getElementById("actions-popup").style.display = "none";
            document.getElementById("actions-popup").classList.add("hidden");
        }

        // Cerrar al hacer clic fuera - versi√≥n mejorada
        document.addEventListener('click', function (event) {
            const actionsPopup = document.getElementById("actions-popup");
            const actionsBtn = document.getElementById("actions-btn");

            if (actionsPopup && !actionsPopup.contains(event.target)) {
                // Si el clic fue fuera del popup y no en el bot√≥n de acciones
                if (actionsBtn && !actionsBtn.contains(event.target)) {
                    closeActionsPopup();
                }
            }
        });

        // Asignar evento al bot√≥n de acciones
        document.getElementById("actions-btn")?.addEventListener("click", function (e) {
            e.stopPropagation();
            const popup = document.getElementById("actions-popup");
            if (popup.style.display === "none" || popup.classList.contains("hidden")) {
                showActionsPopup();
            } else {
                closeActionsPopup();
            }
        });
    </script>

    <script>
        // Agrega esto al final de tu archivo JavaScript existente
        document.addEventListener('DOMContentLoaded', function () {
            const toggleButton = document.getElementById('toggle-camera-info');
            const cameraControl = document.getElementById('camera-control');
            const cameraInfo = document.getElementById('camera-info');

            toggleButton.addEventListener('click', function () {
                cameraControl.classList.toggle('active');
                cameraInfo.classList.toggle('hidden');
            });
        });
    </script>

    <script>
        // Funciones para mostrar/ocultar popups
        // En la funci√≥n showLogin()
        function showLogin() {
            // Cerrar otros popups abiertos
            document.getElementById("pford-credits-box").style.display = "none";
            document.getElementById("signup-box").classList.add("hidden");
            document.getElementById("report-popup").classList.add("hidden");

            // Mostrar el popup de login
            document.getElementById("login-box").classList.remove("hidden");
        }

        function showSignup() {
            // Cierra cualquier popup abierto
            document.getElementById("pford-credits-box").style.display = "none";
            document.getElementById("login-box").classList.add("hidden");
            // Abre el popup de registro
            document.getElementById("signup-box").classList.remove("hidden");
        }

        function closeLoginBox() {
            document.getElementById("login-box").classList.add("hidden");
        }

        function closeSignupBox() {
            document.getElementById("signup-box").classList.add("hidden");
        }

        // Configuraci√≥n de eventos
        document.addEventListener("DOMContentLoaded", function () {
            // Bot√≥n Sign Up en el men√∫ principal
            document.getElementById("pford-credits-button").addEventListener("click", function (e) {
                e.stopPropagation();
                // Solo muestra el primer popup
                document.getElementById("pford-credits-box").style.display = "block";
                // Aseg√∫rate de que los otros popups est√©n cerrados
                document.getElementById("signup-box").classList.add("hidden");
                document.getElementById("login-box").classList.add("hidden");
            });

            // Bot√≥n Sign Up dentro del popup de cr√©ditos
            document.querySelectorAll('.signup-button').forEach(button => {
                button.addEventListener('click', function (e) {
                    e.stopPropagation();
                    // Cierra el primer popup
                    document.getElementById("pford-credits-box").style.display = "none";
                    // Abre el segundo popup
                    document.getElementById("signup-box").classList.remove("hidden");
                });
            });

            // Enlaces "Log in"
            document.querySelectorAll('.login-link a, .login-text a').forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    showLogin();
                });
            });

            // Enlaces "Sign up"
            document.querySelectorAll('.signup-link a').forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    showSignup();
                });
            });

            // Cerrar popups al hacer clic fuera (modificado para no interferir)
            document.addEventListener('click', function (event) {
                const popups = document.querySelectorAll('.pford-popup:not(.hidden), .disclaimer-box:not(.hidden)');
                popups.forEach(popup => {
                    if (!popup.contains(event.target)) {
                        // Solo cerrar si no se hizo clic en ning√∫n bot√≥n que pueda abrirlos
                        if (!event.target.closest('#pford-credits-button, .signup-button, .login-link a, .signup-link a')) {
                            popup.classList.add('hidden');
                        }
                    }
                });
            });
        });

        // El resto de tus funciones (submitSignup, submitLogin, checkSession, etc.) permanecen igual
        async function submitSignup() {
            const email = document.getElementById("institutional-email").value;
            const password = document.getElementById("password").value;
            const confirmPassword = document.getElementById("confirm-password").value;
            const name = document.getElementById("user-name").value;

            if (!name) {
                showAuthPopup('Error', 'Por favor ingresa tu nombre completo', true);
                return;
            }

            if (!email.endsWith('@soyunaq.mx') && !email.endsWith('@unaq.mx')) {
                showAuthPopup('Error', 'Solo se permiten correos institucionales @soyunaq.mx o @unaq.mx', true);
                return;
            }

            if (password.length < 8) {
                showAuthPopup('Error', 'La contrase√±a debe tener al menos 8 caracteres', true);
                return;
            }

            if (password !== confirmPassword) {
                showAuthPopup('Error', 'Las contrase√±as no coinciden', true);
                return;
            }

            try {
                const response = await fetch('/signup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, name })
                });

                const data = await response.json();

                if (data.error) {
                    showAuthPopup('Error', data.error, true);
                } else {
                    // Almacenar datos en sessionStorage
                    sessionStorage.setItem("userEmail", data.user.email);
                    sessionStorage.setItem("userCredits", data.user.credits);
                    sessionStorage.setItem("userName", data.user.name);

                    showAuthPopup('¬°√âxito!', `Bienvenido ${data.user.name}. Has ganado 10 cr√©ditos iniciales.`, false);
                    updateUIForLoggedInUser(data.user);
                    closeSignupBox();
                }
            } catch (error) {
                showAuthPopup('Error', 'Error de conexi√≥n. Intenta nuevamente.', true);
            }
        }

        async function submitLogin() {
            const email = document.getElementById("login-email").value;
            const password = document.getElementById("login-password").value;

            if (!email || !password) {
                showAuthPopup('Error', 'Por favor ingresa tu correo y contrase√±a', true);
                return;
            }

            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (data.error) {
                    showAuthPopup('Error', data.error, true);
                } else {
                    // Almacenar datos en sessionStorage
                    sessionStorage.setItem("userEmail", data.user.email);
                    sessionStorage.setItem("userCredits", data.user.credits);
                    sessionStorage.setItem("userName", data.user.name || data.user.email.split('@')[0]);

                    // Extraer solo el primer nombre del nombre completo
                    const firstName = data.user.name ? data.user.name.split(' ')[0] : data.user.email.split('@')[0];

                    showAuthPopup('¬°Bienvenido!', `Hola ${firstName}. Tienes ${data.user.credits} cr√©ditos.`, false);
                    updateUIForLoggedInUser(data.user);
                    closeLoginBox();
                }
            } catch (error) {
                showAuthPopup('Error', 'Error de conexi√≥n. Intenta nuevamente.', true);
            }
        }
    </script>

    <style>
        .password-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .password-wrapper input {
            flex: 1;
            padding-right: 30px;
        }

        .password-wrapper i {
            position: absolute;
            right: 10px;
            cursor: pointer;
            color: #888;
        }
    </style>

    <script>
        function togglePassword(inputId, iconId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(iconId);
            if (input.type === "password") {
                input.type = "text";
                icon.classList.remove("fa-eye");
                icon.classList.add("fa-eye-slash");
            } else {
                input.type = "password";
                icon.classList.remove("fa-eye-slash");
                icon.classList.add("fa-eye");
            }
        }
    </script>

    <script>
        function checkSession() {
            fetch('/check_session')
                .then(response => response.json())
                .then(data => {
                    if (data.logged_in && data.user) {
                        // Guardar en sessionStorage
                        sessionStorage.setItem("userEmail", data.user.email);
                        sessionStorage.setItem("userCredits", data.user.credits);
                        if (data.user.name) {
                            sessionStorage.setItem("userName", data.user.name);
                        }

                        // Actualizar UI
                        updateUIForLoggedInUser(data.user);
                        updateReportButton(true);
                    } else {
                        updateReportButton(false);
                        // Limpiar sessionStorage si no hay sesi√≥n
                        sessionStorage.removeItem("userEmail");
                        sessionStorage.removeItem("userCredits");
                        sessionStorage.removeItem("userName");
                    }
                })
                .catch(error => console.error('Error verificando sesi√≥n:', error));
        }

        function showAuthPopup(title, message, isError) {
            // Cerrar otros popups abiertos
            document.querySelectorAll('.pford-popup:not(.hidden), .disclaimer-box:not(.hidden)').forEach(popup => {
                popup.classList.add('hidden');
            });

            // Mostrar el popup de autenticaci√≥n
            document.getElementById("auth-success-popup").classList.remove("hidden");
            document.querySelector("#auth-success-popup .intro-title").textContent = title;
            document.getElementById("auth-message").textContent = message;

            if (isError) {
                document.querySelector("#auth-success-popup .accept-button").style.backgroundColor = "#ff4757";
            } else {
                document.querySelector("#auth-success-popup .accept-button").style.backgroundColor = "purple";
            }
        }

        function closeAuthPopup() {
            document.getElementById("auth-success-popup").classList.add("hidden");
        }

        // Funci√≥n para actualizar el estado del bot√≥n de reportar
        function updateReportButton(isLoggedIn) {
            const reportBtn = document.getElementById("report-actions-btn");
            if (reportBtn) {
                // Crear un nuevo bot√≥n para reemplazar el existente
                const newBtn = document.createElement("button");
                newBtn.id = "report-actions-btn";
                newBtn.className = "top-menu-btn"; // Aplica la clase con estilo

                if (isLoggedIn) {
                    newBtn.textContent = "Reportar";
                    newBtn.addEventListener("click", function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        document.getElementById("report-popup").style.display = "flex";
                        document.getElementById("report-popup").classList.add("active");
                        document.getElementById("report-popup").classList.remove("hidden");
                    });
                } else {
                    newBtn.textContent = "Iniciar sesi√≥n";
                    newBtn.addEventListener("click", function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        showLogin(); // Esta funci√≥n debe estar definida correctamente
                    });
                }

                // Reemplazar el bot√≥n antiguo con el nuevo
                reportBtn.parentNode.replaceChild(newBtn, reportBtn);
            }
        }

        // Actualiza la funci√≥n updateUIForLoggedInUser existente
        function updateUIForLoggedInUser(user) {
            // Obtener primer nombre (o email si no hay nombre)
            const firstName = user.name ? user.name.split(' ')[0] : user.email.split('@')[0];

            // 1. Actualizar bot√≥n de cr√©ditos/logout
            const creditsButton = document.getElementById("pford-credits-button");
            if (creditsButton) {
                creditsButton.textContent = "Cerrar sesi√≥n";
                creditsButton.style.backgroundColor = "#8B0000";
                creditsButton.onclick = function () {
                    fetch('/logout')
                        .then(response => response.json())
                        .then(data => {
                            // Limpiar sessionStorage
                            sessionStorage.removeItem("userEmail");
                            sessionStorage.removeItem("userCredits");
                            sessionStorage.removeItem("userName");

                            showAuthPopup('Sesi√≥n cerrada', 'Has cerrado sesi√≥n exitosamente', false);

                            // Actualizar UI inmediatamente
                            updateReportButton(false);

                            // Restablecer sidebar
                            const sidebarLoginText = document.getElementById("sidebar-login-text");
                            const sidebarUserInfo = document.getElementById("sidebar-user-info");
                            const sidebarUserName = document.getElementById("sidebar-user-name");

                            if (sidebarLoginText && sidebarUserInfo && sidebarUserName) {
                                sidebarLoginText.classList.remove("hidden");
                                sidebarUserInfo.classList.add("hidden");
                                sidebarUserName.style.display = "none";
                            }

                            // Restablecer bot√≥n de cr√©ditos
                            creditsButton.textContent = "Registrarse";
                            creditsButton.style.backgroundColor = "purple";
                            creditsButton.onclick = function (e) {
                                e.stopPropagation();
                                document.getElementById("pford-credits-box").style.display = "block";
                            };

                            // Recargar despu√©s de 1.5 segundos
                            setTimeout(() => {
                                window.location.reload();
                            }, 1500);
                        })
                        .catch(error => {
                            showAuthPopup('Error', 'No se pudo cerrar la sesi√≥n', true);
                            console.error('Logout error:', error);
                        });
                };
            }

            // 2. Actualizar informaci√≥n en el sidebar
            const sidebarPhoto = document.getElementById("sidebar-user-photo");
            const sidebarLoginText = document.getElementById("sidebar-login-text");
            const sidebarUserInfo = document.getElementById("sidebar-user-info");
            const sidebarUserName = document.getElementById("sidebar-user-name");
            const sidebarUserEmail = document.getElementById("sidebar-user-email");
            const sidebarUserCredits = document.getElementById("sidebar-user-credits");

            if (sidebarPhoto && sidebarLoginText && sidebarUserInfo && sidebarUserName) {
                sidebarLoginText.classList.add("hidden");
                sidebarUserInfo.classList.remove("hidden");
                sidebarUserName.textContent = firstName;
                sidebarUserName.style.display = "block";
                if (sidebarUserEmail) sidebarUserEmail.textContent = user.email;
                if (sidebarUserCredits) sidebarUserCredits.textContent = `${user.credits} Cr√©ditos`;
            }

            // 3. Actualizar popup de cr√©ditos del logo
            if (document.getElementById("popup-user-email")) {
                document.getElementById("popup-user-email").textContent = `Correo: ${user.email}`;
                document.getElementById("popup-user-credits").textContent = `Cr√©ditos: ${user.credits}`;
            }

            // 4. Actualizar bot√≥n de reportar
            updateReportButton(true);

            // 5. Actualizar cualquier otra UI necesaria
            const reportBtn = document.getElementById("report-actions-btn");
            if (reportBtn) {
                reportBtn.textContent = "Reportar";
                reportBtn.className = "top-menu-btn"; // Asegura que tenga los estilos correctos
            }
        }

        // Configurar el evento de clic para el bot√≥n de reportar
        document.addEventListener("DOMContentLoaded", function () {
            checkSession();

            const reportBtn = document.getElementById("report-actions-btn");
            if (reportBtn) {
                reportBtn.addEventListener("click", function (e) {
                    e.stopPropagation();
                    // El comportamiento se manejar√° en updateReportButton
                });
            }
        });

        document.addEventListener("DOMContentLoaded", function () {
            // --- Verificaci√≥n inicial de sesi√≥n ---
            // 1. Mostrar datos guardados mientras se verifica con el servidor
            const savedEmail = sessionStorage.getItem("userEmail");
            const savedCredits = sessionStorage.getItem("userCredits");
            const savedName = sessionStorage.getItem("userName");

            if (savedEmail) {
                const userData = {
                    email: savedEmail,
                    credits: savedCredits || "0",
                    name: savedName || savedEmail.split('@')[0]
                };
                updateUIForLoggedInUser(userData);
            }

            // 2. Verificaci√≥n con el servidor (tu funci√≥n existente)
            checkSession();

            // ... el resto de tu c√≥digo de inicializaci√≥n ...
        });

        // Funci√≥n centralizada para manejar logout
        function handleLogout() {
            fetch('/logout')
                .then(response => response.json())
                .then(data => {
                    // 1. Limpiar sessionStorage
                    sessionStorage.removeItem("userEmail");
                    sessionStorage.removeItem("userCredits");
                    sessionStorage.removeItem("userName");

                    // 2. Mostrar confirmaci√≥n
                    showAuthPopup('Sesi√≥n cerrada', 'Has cerrado sesi√≥n exitosamente', false);

                    // 3. Actualizar UI inmediatamente
                    updateReportButton(false);

                    // 4. Restablecer sidebar
                    const sidebarLoginText = document.getElementById("sidebar-login-text");
                    const sidebarUserInfo = document.getElementById("sidebar-user-info");
                    const sidebarUserName = document.getElementById("sidebar-user-name");

                    if (sidebarLoginText && sidebarUserInfo && sidebarUserName) {
                        sidebarLoginText.classList.remove("hidden");
                        sidebarUserInfo.classList.add("hidden");
                        sidebarUserName.style.display = "none";
                    }

                    // 5. Recargar despu√©s de 1.5 segundos
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                })
                .catch(error => {
                    showAuthPopup('Error', 'No se pudo cerrar la sesi√≥n', true);
                    console.error('Logout error:', error);
                });
        }

        // Asignar el manejador de eventos
        document.getElementById("logout-btn")?.addEventListener("click", handleLogout);

        // Verificar sesi√≥n al cargar la p√°gina
        checkSession();

        // Agrega esto al final de tu JavaScript
        document.addEventListener("DOMContentLoaded", function () {
            const sidebarProfile = document.getElementById("user-profile-sidebar");

            if (sidebarProfile) {
                sidebarProfile.addEventListener("click", function () {
                    // Verificar si el usuario est√° logueado
                    fetch('/check_session')
                        .then(response => response.json())
                        .then(data => {
                            if (data.logged_in) {
                                // Si est√° logueado, no hacer nada o podr√≠as mostrar un popup de perfil
                            } else {
                                // Si no est√° logueado, mostrar el popup de login
                                showLogin();
                            }
                        });
                });
            }
        });
    </script>

    <script>
        // Funci√≥n para cerrar todos los popups del sidebar
        function closeAllSidebarPopups() {
            document.getElementById("introduction-box").classList.add("hidden");
            document.getElementById("about-box").classList.add("hidden");
        }

        // Funci√≥n para mostrar introducci√≥n
        function showIntroductionBox() {
            closeAllSidebarPopups(); // Cierra otros popups primero
            document.getElementById("introduction-box").classList.remove("hidden");
        }

        // Funci√≥n para cerrar introducci√≥n
        function closeIntroductionBox() {
            document.getElementById("introduction-box").classList.add("hidden");
        }

        // Funci√≥n para mostrar 'Sobre el creador'
        function showAboutBox() {
            closeAllSidebarPopups(); // Cierra otros popups primero
            document.getElementById("about-box").classList.remove("hidden");
        }

        // Funci√≥n para cerrar 'Sobre el creador'
        function closeAboutBox() {
            document.getElementById("about-box").classList.add("hidden");
        }

        document.addEventListener("DOMContentLoaded", function () {
            // Asignar eventos a los botones del men√∫
            document.querySelector("#menu button:nth-child(5)").addEventListener("click", showIntroductionBox);
            document.querySelector("#menu button:nth-child(6)").addEventListener("click", showAboutBox);

            // Ajustes del men√∫ superior
            const topMenu = document.getElementById('top-menu');
            topMenu.style.width = '100%';
            topMenu.style.left = '0';

            // Cerrar popups al hacer clic fuera (opcional)
            document.addEventListener('click', function (event) {
                if (!event.target.closest('#menu button') &&
                    !event.target.closest('.introduction-popup') &&
                    !event.target.closest('.about-popup')) {
                    closeAllSidebarPopups();
                }
            });
        });
    </script>

    <style>
        .introduction-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50%;
            background: rgba(30, 30, 30, 0.95);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 0px 15px rgba(128, 0, 128, 0.5);
            color: white;
            z-index: 10000;
            text-align: center;
        }

        .introduction-header {
            display: flex;
            align-items: center;
            justify-content: center;
            /* Centra el t√≠tulo */
        }

        .intro-title {
            font-size: 38px;
            text-align: center;
            font-weight: bold;
            color: white;
            display: block;
            width: 100%;
        }

        .divider {
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.7);
        }

        /* Nueva clase para organizar la imagen y el video */
        .content-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            /* Espacio entre imagen y video */
        }

        .intro-photo {
            width: 200px;
            height: auto;
            border-radius: 10px;
        }

        .video-container {
            display: flex;
            justify-content: flex-end;
            /* Alinea el video a la derecha */
            width: 100%;
            max-width: 700px;
        }

        .video-container video {
            width: 100%;
            max-width: 650px;
            border-radius: 10px;
        }
    </style>

    <script>
        document.getElementById("toggle-live-data").addEventListener("click", function () {
            var container = document.getElementById("carbon-globe-container");
            var iframe = document.getElementById("carbon-globe");
            var container2 = document.getElementById("container-2");
            var yearSelection = document.getElementById("year-selection");

            if (container.style.display === "none") {
                // Mostrar todos los elementos
                container.style.display = "block";
                container2.style.display = "block";
                yearSelection.style.display = "block";

                iframe.src = "{{ url_for('static', filename='CarbonGlobe/CarbonGlobe.html') }}";

                // Ajustar el tama√±o del iframe despu√©s de cargar
                setTimeout(() => {
                    iframe.style.width = "100%";
                    iframe.style.height = "300px";
                }, 500);
            } else {
                // Ocultar todos los elementos
                container.style.display = "none";
                container2.style.display = "none";
                yearSelection.style.display = "none";
                iframe.src = ""; // Detener la animaci√≥n para liberar memoria
            }
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const toggleBtn = document.getElementById('sidebar-toggle');
            const sidebar = document.getElementById('sidebar');
            const topMenu = document.getElementById('top-menu');
            const mainContent = document.querySelector('main');

            function handleSidebarToggle() {
                sidebar.classList.toggle('sidebar-collapsed');

                // Comportamiento para m√≥vil
                if (window.innerWidth <= 768) {
                    if (sidebar.classList.contains('sidebar-collapsed')) {
                        topMenu.style.left = '0';
                        topMenu.style.width = '100%';
                    } else {
                        topMenu.style.left = '250px';
                        topMenu.style.width = 'calc(100% - 250px)';
                    }
                }
                // Comportamiento para escritorio
                else {
                    if (sidebar.classList.contains('sidebar-collapsed')) {
                        mainContent.classList.add('main-expanded');
                        topMenu.style.width = '100%';
                        topMenu.style.left = '0';
                    } else {
                        mainContent.classList.remove('main-expanded');
                        topMenu.style.width = 'calc(100% - 300px)';
                        topMenu.style.left = '300px';
                    }
                }
            }

            toggleBtn.addEventListener('click', handleSidebarToggle);

            // Asegurar estado inicial correcto
            if (window.innerWidth > 768 && sidebar.classList.contains('sidebar-collapsed')) {
                mainContent.classList.add('main-expanded');
            }
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const logoImg = document.querySelector(".logo");
            const popup = document.getElementById("user-credit-popup");

            logoImg.addEventListener("click", () => {
                if (sessionStorage.getItem("userEmail")) {
                    // Llenar datos
                    document.getElementById("popup-user-email").textContent = `Correo: ${sessionStorage.getItem("userEmail")}`;
                    document.getElementById("popup-user-credits").textContent = `Cr√©ditos: ${sessionStorage.getItem("userCredits")}`;
                    popup.classList.toggle("hidden");
                }
            });

            // Cerrar si haces clic fuera
            document.addEventListener("click", (e) => {
                if (!popup.contains(e.target) && !logoImg.contains(e.target)) {
                    popup.classList.add("hidden");
                }
            });
        });

        // Cerrar popups al hacer clic fuera de ellos
        document.addEventListener('click', function (event) {
            const popups = document.querySelectorAll('.pford-popup:not(.hidden), .disclaimer-box:not(.hidden)');
            popups.forEach(popup => {
                if (!popup.contains(event.target) &&
                    !event.target.matches('#pford-credits-button, #pford-credits-button *, #logout-btn, #logout-btn *')) {
                    popup.classList.add('hidden');
                }
            });
        });
    </script>

    <script>

        function showReportPopup() {
            const reportPopup = document.getElementById("report-popup");
            reportPopup.style.display = "flex";
            reportPopup.classList.remove("hidden");
        }

        function submitReportAction() {
            const actionType = document.getElementById("action-type").value;
            const otherAction = document.getElementById("other-action").value;
            const imageFile = document.getElementById("report-image").files[0];

            if (!actionType) {
                showAuthPopup('Error', 'Por favor selecciona un tipo de acci√≥n', true);
                return;
            }

            if (actionType === "otro" && !otherAction) {
                showAuthPopup('Error', 'Por favor describe la acci√≥n realizada', true);
                return;
            }

            if (!imageFile) {
                showAuthPopup('Error', 'Por favor sube una foto como evidencia', true);
                return;
            }

            const formData = new FormData();
            formData.append('action_type', actionType);
            formData.append('description', actionType === "otro" ? otherAction :
                document.getElementById("action-type").options[document.getElementById("action-type").selectedIndex].text);
            formData.append('image', imageFile);

            fetch('/report_action', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAuthPopup('√âxito', '¬°Acci√≥n reportada con √©xito! Se verificar√° pronto.', false);
                        closeReportPopup();
                    } else {
                        showAuthPopup('Error', data.error || 'Error al enviar el reporte', true);
                    }
                })
                .catch(error => {
                    showAuthPopup('Error', 'Error de conexi√≥n: ' + error.message, true);
                });
        }

        // Asignar el event listener correctamente
        document.addEventListener("DOMContentLoaded", function () {
            const reportBtn = document.getElementById("report-actions-btn");
            if (reportBtn) {
                reportBtn.addEventListener("click", function (e) {
                    e.stopPropagation();
                    showReportPopup(); // Llama a la funci√≥n actualizada que definimos antes
                });
            }
        });
    </script>

    <script>
        // Manejar el men√∫ en dispositivos m√≥viles
        document.addEventListener('DOMContentLoaded', function () {
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            const topMenu = document.getElementById('top-menu');

            if (mobileMenuToggle) {
                mobileMenuToggle.addEventListener('click', function () {
                    topMenu.classList.toggle('mobile-menu-expanded');
                });
            }

            // Cerrar men√∫s al hacer clic fuera
            document.addEventListener('click', function (e) {
                if (mobileMenuToggle && !mobileMenuToggle.contains(e.target)) {
                    topMenu.classList.remove('mobile-menu-expanded');
                }
            });
        });
    </script>

    <script>
        // Mostrar/ocultar campo "Otro" cuando se selecciona esa opci√≥n
        document.getElementById("action-type").addEventListener("change", function () {
            const otherContainer = document.getElementById("other-action-container");
            if (this.value === "otro") {
                otherContainer.classList.remove("hidden");
            } else {
                otherContainer.classList.add("hidden");
            }
        });

        // Cerrar al hacer clic fuera
        document.addEventListener('click', function (event) {
            const reportPopup = document.getElementById("report-popup");
            const reportBtn = document.getElementById("report-actions-btn");

            if (reportPopup && !reportPopup.contains(event.target)) {
                if (reportBtn && !reportBtn.contains(event.target)) {
                    closeReportPopup();
                }
            }
        });
    </script>

    <script>
        // Funci√≥n para cerrar el popup de reporte
        function closeReportPopup() {
            const reportPopup = document.getElementById("report-popup");
            if (reportPopup) {
                reportPopup.classList.add("hidden");
                reportPopup.style.display = "none";

                // Opcional: Resetear el formulario
                document.getElementById("action-type").value = "";
                document.getElementById("other-action").value = "";
                document.getElementById("other-action-container").classList.add("hidden");
                document.getElementById("report-image").value = "";
            }
        }

        // Funci√≥n para enviar el reporte
        function submitReportAction() {
            const actionType = document.getElementById("action-type").value;
            const otherAction = document.getElementById("other-action").value;
            const imageFile = document.getElementById("report-image").files[0];

            if (!actionType) {
                showAuthPopup('Error', 'Por favor selecciona un tipo de acci√≥n', true);
                return;
            }

            if (actionType === "otro" && !otherAction) {
                showAuthPopup('Error', 'Por favor describe la acci√≥n realizada', true);
                return;
            }

            if (!imageFile) {
                showAuthPopup('Error', 'Por favor sube una foto como evidencia', true);
                return;
            }

            const formData = new FormData();
            formData.append('action_type', actionType);
            formData.append('description', actionType === "otro" ? otherAction :
                document.getElementById("action-type").options[document.getElementById("action-type").selectedIndex].text);
            formData.append('image', imageFile);

            fetch('/report_action', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAuthPopup('√âxito', '¬°Acci√≥n reportada con √©xito! Se verificar√° pronto.', false);
                        closeReportPopup();

                        // Actualizar los cr√©ditos del usuario si la respuesta los incluye
                        if (data.user_credits !== undefined) {
                            updateUserCredits(data.user_credits);
                        }
                    } else {
                        showAuthPopup('Error', data.error || 'Error al enviar el reporte', true);
                    }
                })
                .catch(error => {
                    showAuthPopup('Error', 'Error de conexi√≥n: ' + error.message, true);
                });
        }

        // Funci√≥n auxiliar para actualizar los cr√©ditos del usuario en la UI
        function updateUserCredits(credits) {
            const creditsElements = [
                document.getElementById("sidebar-user-credits"),
                document.getElementById("popup-user-credits")
            ];

            creditsElements.forEach(el => {
                if (el) el.textContent = `${credits} Cr√©ditos`;
            });
        }

        // Asignar el evento al bot√≥n de reportar cuando el DOM est√© listo
        document.addEventListener("DOMContentLoaded", function () {
            // Cerrar al hacer clic fuera
            document.addEventListener('click', function (event) {
                const reportPopup = document.getElementById("report-popup");
                const reportBtn = document.getElementById("report-actions-btn");

                if (reportPopup && !reportPopup.contains(event.target)) {
                    if (reportBtn && !reportBtn.contains(event.target)) {
                        closeReportPopup();
                    }
                }
            });

            // Mostrar/ocultar campo "Otro" cuando se selecciona esa opci√≥n
            document.getElementById("action-type").addEventListener("change", function () {
                const otherContainer = document.getElementById("other-action-container");
                if (this.value === "otro") {
                    otherContainer.classList.remove("hidden");
                } else {
                    otherContainer.classList.add("hidden");
                }
            });
        });
    </script>

    <script>
        // Funciones para el leaderboard
        function showLeaderboardPopup() {
            fetchLeaderboardData();
            document.getElementById("leaderboard-popup").style.display = "flex";
            document.getElementById("leaderboard-popup").classList.remove("hidden");
        }

        function closeLeaderboardPopup() {
            document.getElementById("leaderboard-popup").style.display = "none";
            document.getElementById("leaderboard-popup").classList.add("hidden");
        }

        function fetchLeaderboardData() {
            // Mostrar loader mientras carga
            const leaderboardBody = document.getElementById("leaderboard-body");
            leaderboardBody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px;">Cargando...</td></tr>';

            // Cachear la √∫ltima respuesta para evitar peticiones redundantes
            if (window.lastLeaderboardFetch && (Date.now() - window.lastLeaderboardFetch.time < 30000)) {
                renderLeaderboard(window.lastLeaderboardFetch.data);
                return;
            }

            // Usar fetch con AbortController para timeout
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 3000); // Timeout de 3 segundos

            fetch('/get_leaderboard', { signal: controller.signal })
                .then(response => {
                    clearTimeout(timeout);
                    if (!response.ok) throw new Error('Error en la respuesta');
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Cachear la respuesta
                        window.lastLeaderboardFetch = {
                            time: Date.now(),
                            data: data.users
                        };
                        renderLeaderboard(data.users);
                    }
                })
                .catch(error => {
                    console.error('Error fetching leaderboard:', error);
                    leaderboardBody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #ff4757;">Error al cargar datos</td></tr>';
                });
        }

        function renderLeaderboard(users) {
            const leaderboardBody = document.getElementById("leaderboard-body");

            // Usar DocumentFragment para renderizado m√°s r√°pido
            const fragment = document.createDocumentFragment();

            users.forEach((user, index) => {
                const row = document.createElement('tr');

                // Aplicar estilos a los primeros 3 lugares
                if (index < 3) row.classList.add(['gold', 'silver', 'bronze'][index]);

                row.innerHTML = `
            <td>${index < 3 ? ['ü•á', 'ü•à', 'ü•â'][index] + ' ' : ''}#${index + 1}</td>
            <td class="leaderboard-user">
                <img src="/static/images/Pford_2.jpg" alt="${user.name}" class="leaderboard-avatar" loading="lazy">
                <span class="leaderboard-name">${user.name}</span>
            </td>
            <td class="leaderboard-credits">üü¢ ${user.credits} Pford Credits</td>
        `;

                fragment.appendChild(row);
            });

            leaderboardBody.innerHTML = '';
            leaderboardBody.appendChild(fragment);
        }

        // Precargar datos cuando el mouse entra al bot√≥n (opcional)
        document.querySelector("#menu button:first-child").addEventListener('mouseenter', function () {
            if (!window.lastLeaderboardFetch) {
                fetchLeaderboardData();
            }
        });

        // Asignar evento al bot√≥n de Tabla de Posiciones
        document.addEventListener("DOMContentLoaded", function () {
            const leaderboardBtn = document.querySelector("#menu button:first-child");
            if (leaderboardBtn) {
                leaderboardBtn.addEventListener("click", showLeaderboardPopup);
            }

            // Cerrar al hacer clic fuera
            document.addEventListener('click', function (event) {
                const leaderboardPopup = document.getElementById("leaderboard-popup");
                if (leaderboardPopup && !leaderboardPopup.contains(event.target) &&
                    !event.target.matches("#menu button:first-child, #menu button:first-child *")) {
                    closeLeaderboardPopup();
                }
            });
        });
    </script>

</body>

</html>
